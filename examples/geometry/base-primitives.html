<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SeaGL â€¢ Base Primitives</title>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
        <link rel="icon" type="image/png" href="../../files/logo/favicon.png" />
        <link rel="stylesheet" href="../main.css" />
    </head>
    <body>
        <div class="Info">Base Primitives</div>
        <div class="Credits" id="debugInfo" style="line-height: 150%;"></div>

        <script src="../imports.js"></script>

        <script type="module">
            import * as SGL from 'seagl';
            import { Gooey } from 'suey';

            // Gui

            const debugInfo = document.getElementById('debugInfo');

            const geomTypes = [ 'Box', 'Cylinder', 'Plane', 'Sphere', 'Torus', 'Tube' ];
            const geoms = {}, nonIndexed = {};
            const meshes = {}, meshesNon = {};

            const params = {
                type: 'Torus',
                logToConsole: () => logVisibleGeometry(),
                indexed: true,
                flatShading: false,
                normalIntensity: 0.5,
                opacity: 1.0,
                tint: new SGL.Vec3(1, 1, 1),
                tintIntensity: 0.0,
                wireframe: false,
                wireIntensity: 0.0,
            }

            const gui = new Gooey();
            const folder1 = gui.addFolder('Geometry');
            const folder2 = gui.addFolder('Material');

            folder1.add(params, 'type', geomTypes).onChange(setVisibleGeometry);
            folder1.add(params, 'logToConsole').name('Debug');
            folder1.add(params, 'indexed').onChange(setVisibleGeometry);

            folder2.add(params, 'flatShading').onChange(() => program.flatShading = params.flatShading);
            folder2.add(params, 'normalIntensity', 0.0, 1.0).onChange(() => program.normalIntensity = params.normalIntensity);
            folder2.add(params, 'opacity', 0.0, 1.0).onChange(() => program.opacity = params.opacity);
            folder2.addColor(params, 'tint').onChange(() => program.tint = params.tint);
            folder2.add(params, 'tintIntensity', 0.0, 1.0).onChange(() => program.tintIntensity = params.tintIntensity);
            folder2.add(params, 'wireframe').onChange(toggleWireframe);
            folder2.add(params, 'wireIntensity', 0, 1).onChange(() => program.wireIntensity = params.wireIntensity);

            // Scene

            const renderer = new SGL.Renderer({ dpr: 2 });
            const gl = renderer.gl;
            document.body.appendChild(gl.canvas);

            const camera = new SGL.Camera({ fov: 35 });
            camera.position.set(5, 3, 6);
            camera.lookAt([ 0, 0, 0 ]);

            function resize() {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.perspective({ aspect: gl.canvas.width / gl.canvas.height });
            }
            window.addEventListener('resize', resize, false);
            resize();

            const texture = SGL.TextureLoader.load({ src: '../../files/textures/uv-test-col.png' });

            const scene = new SGL.Transform();
            const controls = new SGL.Orbit(camera);

            const program = new SGL.Uber({
                // cullFace: null,
                normalIntensity: params.normalIntensity,
                opacity: params.opacity,
                texture: texture,
                transparent: true
            });

            /***** Geometries *****/

            geoms['Box'] = new SGL.Box({
                width: 1.5,
                height: 1.5,
                depth: 1.5,
            });

            geoms['Cylinder'] = new SGL.Cylinder({
                radiusTop: 1.0,
                radiusBottom: 1.0,
                height: 2
            });

            geoms['Plane'] = new SGL.Plane({ width: 1.5, height: 1.5 });

            geoms['Sphere'] = new SGL.Sphere({ radius: 1.25 });

            geoms['Torus'] = new SGL.Torus({
                radius: 1,
                tube: 0.4,
                radialSegments: 16,
                tubularSegments: 32,
            });

            // Tube, first three is for moveTo command, rest for bezierCurveTo command
            const pathCoords = [ -1.0, 0.0, 0.0, -0.9368709325790405, 0.1762027144432068, 0.04529910162091255, -0.7061498761177063, 0.089231938123703, 0.19381383061408997, -0.6332840919494629, 0.2674865424633026, 0.1930660903453827, -0.5615311861038208, 0.4430185854434967, 0.1923297792673111, -0.7734173536300659, 0.5522762537002563, 0.08718681335449219, -0.7070468664169312, 0.7070468664169312, 0.0, -0.6498651504516602, 0.8403899073600769, -0.07511603832244873, -0.5399253368377686, 0.8584117889404297, -0.16668838262557983, -0.38917776942253113, 0.921392560005188, -0.1677459478378296, -0.23391252756118774, 0.9862607717514038, -0.16883520781993866, -0.14611071348190308, 1.0727460384368896, -0.04093937203288078, 0.0, 1.0, 0.0, 0.1674281358718872, 0.9166403412818909, 0.046912387013435364, 0.07777689397335052, 0.6478093862533569, -0.06732462346553802, 0.2400655597448349, 0.5683639645576477, 0.0, 0.4298238456249237, 0.4754713177680969, 0.07872024923563004, 0.49316900968551636, 0.7766210436820984, 0.32597726583480835, 0.7070468664169312, 0.7070468664169312, 0.3101717531681061, 0.8896822333335876, 0.647635817527771, 0.29667505621910095, 0.8556811809539795, 0.5579423308372498, 0.06533028930425644, 0.921392560005188, 0.38917776942253113, 0.0, 0.9742976427078247, 0.2533031702041626, -0.05259828269481659, 1.0508142709732056, 0.14183028042316437, -0.036462459713220596, 1.0, 0.0, 0.0, 0.9368709325790405, -0.1762027144432068, 0.04529910162091255, 0.7061498761177063, -0.089231938123703, 0.19381383061408997, 0.6332840919494629, -0.2674865424633026, 0.1930660903453827, 0.5615311861038208, -0.4430185854434967, 0.1923297792673111, 0.7734173536300659, -0.5522762537002563, 0.08718681335449219, 0.7070468664169312, -0.7070468664169312, 0.0, 0.6498651504516602, -0.8403899073600769, -0.07511603832244873, 0.5399253368377686, -0.8584117889404297, -0.16668838262557983, 0.38917776942253113, -0.921392560005188, -0.1677459478378296, 0.23391252756118774, -0.9862607717514038, -0.16883520781993866, 0.14611071348190308, -1.0727460384368896, -0.04093937203288078, 0.0, -1.0, 0.0, -0.1674281358718872, -0.9166403412818909, 0.046912387013435364, -0.07777689397335052, -0.6478093862533569, -0.06732462346553802, -0.2400655597448349, -0.5683639645576477, 0.0, -0.4298238456249237, -0.4754713177680969, 0.07872024923563004, -0.49316900968551636, -0.7766210436820984, 0.32597726583480835, -0.7070468664169312, -0.7070468664169312, 0.3101717531681061, -0.8896822333335876, -0.647635817527771, 0.29667505621910095, -0.8556811809539795, -0.5579423308372498, 0.06533028930425644, -0.921392560005188, -0.38917776942253113, 0.0, -0.9742976427078247, -0.2533031702041626, -0.05259828269481659, -1.0508142709732056, -0.14183028042316437, -0.036462459713220596, -1.0, 0.0, 0.0 ];
            const path = new SGL.Path();
            path.tiltFunction = (angle, t, path) => 8 * 360 * t;
            path.moveTo(new SGL.Vec3(pathCoords[0], pathCoords[1], pathCoords[2]));
            for (let i = 3; i < pathCoords.length; i += 9) {
                const cp1 = new SGL.Vec3(pathCoords[i + 0], pathCoords[i + 1], pathCoords[i + 2]);
                const cp2 = new SGL.Vec3(pathCoords[i + 3], pathCoords[i + 4], pathCoords[i + 5]);
                const p = new SGL.Vec3(pathCoords[i + 6], pathCoords[i + 7], pathCoords[i + 8]);
                path.bezierCurveTo(cp1, cp2, p);
            }
            const pathSubdivisions = 256;
            const points = path.getPoints(pathSubdivisions);
            const frenetFrames = path.computeFrenetFrames(pathSubdivisions, true);
            geoms['Tube'] = new SGL.Tube({ path, radius: 0.1, tubularSegments: 256, radialSegments: 16, closed: true });

            // Vertex Normals
            const CLEAN = true;
            const COMPUTE = true;

            for (const key in geoms) {
                const geometry = geoms[key];
                if (CLEAN) SGL.GeomUtils.cleanAttributes(geometry);
                if (COMPUTE) SGL.GeomUtils.computeVertexNormals(geometry);
                meshes[key] = new SGL.Mesh({ geometry: geometry, program });
                scene.addChild(meshes[key]);

                const clone = geometry.clone();
                SGL.GeomUtils.toNonIndexed(clone);
                // SGL.GeomUtils.toIndexed(boxGeometry, [ 'normal' ]);
                // SGL.GeomUtils.computeVertexNormals(boxGeometry);
                // SGL.GeomUtils.toNonIndexed(boxGeometry);
                meshesNon[key] = new SGL.Mesh({ geometry: clone, program });
                scene.addChild(meshesNon[key]);
            }

            function logVisibleGeometry() {
                for (const key in meshes) {
                    if (params.indexed && meshes[key].visible) console.log(meshes[key]);
                    if (!params.indexed && meshesNon[key].visible) console.log(meshesNon[key]);
                }
            }

            function setVisibleGeometry() {
                let mesh = undefined;
                for (const key in meshes) {
                    meshes[key].visible = (params.indexed && params.type === key);
                    meshesNon[key].visible = (!params.indexed && params.type === key);
                    if (meshes[key].visible) mesh = meshes[key];
                    if (meshesNon[key].visible) mesh = meshesNon[key];
                }
                if (mesh) {
                    // \u000A is unicode literal for new line (equivalent to inserting '<br />' element)
                    let info = `Mesh: ${params.type} - Indexed: ${params.indexed ? 'Yes' : 'No'}\u000A`;
                    if (params.indexed) info += `Indices: ${mesh.geometry.attributes.index.data.length}\u000A`;
                    info += `Positions: ${mesh.geometry.attributes.position.data.length}\u000A`;
                    info += `Normals: ${mesh.geometry.attributes.normal.data.length}\u000A`;
                    debugInfo.innerText = info;
                }
            }
            setVisibleGeometry();

            // normal: TRIANGLES, wireframe options: LINES, LINE_STRIP, LINE_LOOP, etc.
            function toggleWireframe() {
                for (const key in meshes) {
                    meshes[key].mode = (params.wireframe) ? gl.LINE_STRIP : gl.TRIANGLES;
                    meshesNon[key].mode = (params.wireframe) ? gl.LINE_STRIP : gl.TRIANGLES;
                }
            }

            const debug = new SGL.Debug();
            requestAnimationFrame(update);
            function update(t) {
                requestAnimationFrame(update);
                debug.startFrame();
                controls.update();
                renderer.render({ scene, camera });
                debug.endFrame();
            }

        </script>
    </body>
</html>